import {PluginRegistry,ResourceMerger}from'@cruxjs/base';export*from'@cruxjs/base';import {Logger}from'@minejs/logger';import {server}from'@minejs/server';import {DB}from'@minejs/db';import*as E from'sass';async function F(r,s){if(!r.client)return null;s.info("Building client...");try{let e=await Bun.build({entrypoints:[r.client.entry],outdir:r.client.output,target:r.client.target||"browser",minify:r.client.minify??!r.debug,sourcemap:r.client.sourcemap??r.debug?"inline":"none",external:r.client.external||[]});if(!e.success)throw new Error("Build failed");let t=e.outputs.map(o=>o.path);return s.debug(`Client built \u2192 ${t.join(", ")}`),{success:!0,outputs:t}}catch(e){throw s.error("Failed to build client",e.message),e}}async function I(r,s){if(!r.style)return s.info("No style config provided, skipping style build"),null;s.info(`Building styles from: ${r.style.entry}...`);try{let e=r.style.output,t=e.lastIndexOf("/"),o=e.substring(0,t),i=e.substring(t+1),{mkdir:c}=await import('fs/promises');await c(o,{recursive:!0});let l=E.compile(r.style.entry,{style:r.style.minify?"compressed":"expanded",sourceMap:!!r.style.sourcemap});return await Bun.write(e,l.css),s.info(`Compiled SCSS to CSS \u2192 ${i}`),s.debug(`Styles built \u2192 ${e}`),{success:!0,output:e}}catch(e){return s.error("Failed to build styles",e.message),{success:false,output:r.style?.output||"unknown"}}}async function T(r,s,e){let t=new Map;if(!r.database&&s.length===0)return e.info("No database config, skipping setup"),t;let o=r.database?Array.isArray(r.database)?r.database:[r.database]:[];e.info("Setting up databases...");for(let i of o){let c=i.name||"default",l=new DB(i.connection);if(i.schema)try{let u=await import(i.schema),d=u.default||u.schema;if(Array.isArray(d))for(let n of d)l.defineSchema(n);}catch(u){throw e.error(`Failed to load schema: ${i.schema}`,u.message),u}for(let u of s)l.defineSchema(u);t.set(c,l),e.debug(`Database '${c}' ready`);}if(t.size===0&&s.length>0){let i=new DB(":memory:");for(let c of s)i.defineSchema(c);t.set("default",i),e.debug("Database 'default' ready (in-memory for plugins)");}return t}async function k(r,s){if(!r.api)return [];s.info(`Loading routes from ${r.api.directory}...`);let e=[];try{let t=await P(r.api.directory);for(let o of t)try{let i=await import(o),c=i.default||i.routes;Array.isArray(c)&&e.push(...c);}catch(i){s.error(`Failed to load routes from ${o}`,i.message);}return s.debug(`Routes loaded \u2192 ${e.length} routes`),e}catch(t){return s.error("Failed to scan route directory",t.message),[]}}async function P(r){let s=[];try{let e=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(r));for(let t of e)s.push(`${r}/${t}`);}catch{}return s}function U(r,s){let e=s?.onConfig?s.onConfig(r):r,t=new Logger(e.debug?"debug":"info",true,"CruxJS"),o=new PluginRegistry(t),i=new ResourceMerger(t),c=new Map,l=new Map,u=null,d=null,n={config:e,databases:c,plugins:[]},h={config:e,server:null,databases:c,plugins:[],middlewares:l,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>n,getMiddleware:a=>l.get(a)};async function R(){if(!e.plugins||e.plugins.length===0){t.info("No plugins to register");return}t.debug("REGISTER");for(let p of e.plugins)await o.register(p,h);n.plugins=o.getAll(),o.collectMiddlewares().forEach((p,f)=>l.set(f,p));}async function C(){t.debug("AWAKE");try{d=await F(e,t),n.clientBuild=d;let a=await I(e,t);n.styleBuild=a;let p=o.collectSchemas(),f=await T(e,p,t);c.clear(),f.forEach((m,w)=>c.set(w,m)),await o.callHook("onAwake",n),await s?.onAwake?.(n);}catch(a){throw await s?.onError?.(n,"AWAKE",a),a}}async function v(){t.debug("START");try{let a=await k(e,t),p=o.collectRoutes(),m=[...e.routes||[],...a],w=i.mergeRoutes(m,p),$=e.static?Array.isArray(e.static)?e.static:[e.static]:[],D=o.collectStatic(),b=i.mergeStatic($,D);t.info("Creating server...");let A;for(let g of n.plugins){let y=g;if(y.__spaErrorHandler){A=y.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${g.name}`);break}}u=await server({port:e.server?.port||3e3,hostname:e.server?.host||"localhost",logging:e.server?.logging,routes:w,static:b.length>0?b:void 0,security:e.security,middlewares:e.middlewares,i18n:e.i18n?{defaultLanguage:e.i18n.defaultLanguage,supportedLanguages:e.i18n.supportedLanguages,basePath:e.i18n.basePath,fileExtension:e.i18n.fileExtension||"json"}:void 0,onError:A}),c.forEach((g,y)=>{u.db.set(y,g);}),n.server=u,h.server=u,t.debug(`Server created \u2192 ${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await o.callHook("onStart",n),await s?.onStart?.(n);}catch(a){throw await s?.onError?.(n,"START",a),a}}async function x(){t.debug("READY");try{await u.start(),t.debug(`Server running on http://${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await o.callHook("onReady",n),await s?.onReady?.(n);}catch(a){throw await s?.onError?.(n,"READY",a),a}}return {config:e,server:u,databases:c,plugins:n.plugins,middlewares:l,async start(){await R(),await C(),await v(),await x();},async stop(){t.info("Stopping server...");try{u&&await u.stop(),c.forEach((a,p)=>{a.close(),t.info(`Database '${p}' closed`);}),await o.callHook("onShutdown",n),await s?.onFinish?.(n),t.debug("Server stopped");}catch(a){throw t.error("Failed to stop server",a.message),a}},async restart(){await this.stop(),await this.start();},getContext(){return n},getMiddleware(a){return l.get(a)}}}
export{U as createApp};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map