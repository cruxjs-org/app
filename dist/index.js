import {Logger,PluginRegistry,ResourceMerger}from'@cruxjs/base';export*from'@cruxjs/base';import {server}from'@minejs/server';import {DB}from'@minejs/db';import {setupAuto}from'@minejs/i18n';async function F(r,a){if(!r.client)return null;a.info("Building client...");try{let e=await Bun.build({entrypoints:[r.client.entry],outdir:r.client.output,target:r.client.target||"browser",minify:r.client.minify??!r.debug,sourcemap:r.client.sourcemap??r.debug?"inline":"none",external:r.client.external||[]});if(!e.success)throw new Error("Build failed");let t=e.outputs.map(o=>o.path);return a.success(`Client built \u2192 ${t.join(", ")}`),{success:!0,outputs:t}}catch(e){throw a.error("Failed to build client",e),e}}async function T(r,a,e){let t=new Map;if(!r.database&&a.length===0)return e.info("No database config, skipping setup"),t;let o=r.database?Array.isArray(r.database)?r.database:[r.database]:[];e.info("Setting up databases...");for(let i of o){let u=i.name||"default",l=new DB(i.connection);if(i.schema)try{let c=await import(i.schema),d=c.default||c.schema;if(Array.isArray(d))for(let n of d)l.defineSchema(n);}catch(c){throw e.error(`Failed to load schema: ${i.schema}`,c),c}for(let c of a)l.defineSchema(c);t.set(u,l),e.success(`Database '${u}' ready`);}if(t.size===0&&a.length>0){let i=new DB(":memory:");for(let u of a)i.defineSchema(u);t.set("default",i),e.success("Database 'default' ready (in-memory for plugins)");}return t}async function I(r,a){if(r.i18n){a.info("Setting up i18n...");try{await setupAuto({defaultLanguage:r.i18n.defaultLanguage,supportedLanguages:r.i18n.supportedLanguages,basePath:r.i18n.basePath,fileExtension:r.i18n.fileExtension||"json"}),a.success(`i18n ready \u2192 ${r.i18n.supportedLanguages.join(", ")}`);}catch(e){throw a.error("Failed to setup i18n",e),e}}}async function j(r,a){if(!r.api)return [];a.info(`Loading routes from ${r.api.directory}...`);let e=[];try{let t=await P(r.api.directory);for(let o of t)try{let i=await import(o),u=i.default||i.routes;Array.isArray(u)&&e.push(...u);}catch(i){a.error(`Failed to load routes from ${o}`,i);}return a.success(`Routes loaded \u2192 ${e.length} routes`),e}catch(t){return a.error("Failed to scan route directory",t),[]}}async function P(r){let a=[];try{let e=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(r));for(let t of e)a.push(`${r}/${t}`);}catch{}return a}function q(r,a){let e=a?.onConfig?a.onConfig(r):r,t=new Logger(e.debug),o=new PluginRegistry(t),i=new ResourceMerger(t),u=new Map,l=new Map,c=null,d=null,n={config:e,databases:u,plugins:[]},h={config:e,server:null,databases:u,plugins:[],middlewares:l,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>n,getMiddleware:s=>l.get(s)};async function E(){if(!e.plugins||e.plugins.length===0){t.info("No plugins to register");return}t.phase("REGISTER");for(let p of e.plugins)await o.register(p,h);n.plugins=o.getAll(),o.collectMiddlewares().forEach((p,f)=>l.set(f,p));}async function R(){t.phase("AWAKE");try{d=await F(e,t),n.clientBuild=d;let s=o.collectSchemas(),p=await T(e,s,t);u.clear(),p.forEach((f,w)=>u.set(w,f)),await I(e,t),await o.callHook("onAwake",n),await a?.onAwake?.(n);}catch(s){throw await a?.onError?.(n,"AWAKE",s),s}}async function S(){t.phase("START");try{let s=await j(e,t),p=o.collectRoutes(),w=[...e.routes||[],...s],C=i.mergeRoutes(w,p),L=e.static?Array.isArray(e.static)?e.static:[e.static]:[],$=o.collectStatic(),m=i.mergeStatic(L,$);t.info("Creating server...");let A;for(let g of n.plugins){let y=g;if(y.__spaErrorHandler){A=y.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${g.name}`);break}}c=server({port:e.server?.port||3e3,hostname:e.server?.host||"localhost",logging:e.server?.logging,routes:C,static:m.length>0?m:void 0,security:e.security,middlewares:e.middlewares,i18n:e.i18n?{defaultLanguage:e.i18n.defaultLanguage,supportedLanguages:e.i18n.supportedLanguages}:void 0,onError:A}),u.forEach((g,y)=>{c.db.set(y,g);}),n.server=c,h.server=c,t.success(`Server created \u2192 ${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await o.callHook("onStart",n),await a?.onStart?.(n);}catch(s){throw await a?.onError?.(n,"START",s),s}}async function v(){t.phase("READY");try{await c.start(),t.success(`Server running on http://${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await o.callHook("onReady",n),await a?.onReady?.(n);}catch(s){throw await a?.onError?.(n,"READY",s),s}}return {config:e,server:c,databases:u,plugins:n.plugins,middlewares:l,async start(){await E(),await R(),await S(),await v();},async stop(){t.info("Stopping server...");try{c&&await c.stop(),u.forEach((s,p)=>{s.close(),t.info(`Database '${p}' closed`);}),await o.callHook("onShutdown",n),await a?.onFinish?.(n),t.success("Server stopped");}catch(s){throw t.error("Failed to stop server",s),s}},async restart(){await this.stop(),await this.start();},getContext(){return n},getMiddleware(s){return l.get(s)}}}
export{q as createApp};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map