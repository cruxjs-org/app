import {Logger,PluginRegistry,ResourceMerger}from'@cruxjs/base';export*from'@cruxjs/base';import {server}from'@minejs/server';import {DB}from'@minejs/db';import*as R from'sass';async function k(e,r){if(!e.client)return null;r.info("Building client...");try{let t=await Bun.build({entrypoints:[e.client.entry],outdir:e.client.output,target:e.client.target||"browser",minify:e.client.minify??!e.debug,sourcemap:e.client.sourcemap??e.debug?"inline":"none",external:e.client.external||[]});if(!t.success)throw new Error("Build failed");let s=t.outputs.map(a=>a.path);return r.success(`Client built \u2192 ${s.join(", ")}`),{success:!0,outputs:s}}catch(t){throw r.error("Failed to build client",t),t}}async function F(e,r){if(!e.ui)return r.info("No UI config provided, skipping UI build"),null;r.info(`Building UI from package: ${e.ui.package}...`);try{let t=`./node_modules/${e.ui.package}/dist/mineui.css`,s=`${e.ui.output}/min.css`;try{let{mkdir:a}=await import('fs/promises');await a(e.ui.output,{recursive:!0});let o=Bun.file(t);await o.exists()?(await Bun.write(s,o),r.info(`Copied UI CSS \u2192 ${s}`)):r.info(`UI source file not found: ${t}`);}catch(a){r.error(`Failed to copy UI CSS: ${a}`);}return r.success(`UI built \u2192 ${e.ui.output}`),{success:!0,output:e.ui.output}}catch(t){throw r.error("Failed to build UI",t),t}}async function H(e,r){if(!e.style)return r.info("No style config provided, skipping style build"),null;r.info(`Building styles from: ${e.style.entry}...`);try{let t=e.style.output,s=t.lastIndexOf("/"),a=t.substring(0,s),o=t.substring(s+1),{mkdir:c}=await import('fs/promises');await c(a,{recursive:!0});let l=R.compile(e.style.entry,{style:e.style.minify?"compressed":"expanded",sourceMap:!!e.style.sourcemap});return await Bun.write(t,l.css),r.info(`Compiled SCSS to CSS \u2192 ${o}`),r.success(`Styles built \u2192 ${t}`),{success:!0,output:t}}catch(t){return r.error("Failed to build styles",t),{success:false,output:e.style?.output||"unknown"}}}async function U(e,r,t){let s=new Map;if(!e.database&&r.length===0)return t.info("No database config, skipping setup"),s;let a=e.database?Array.isArray(e.database)?e.database:[e.database]:[];t.info("Setting up databases...");for(let o of a){let c=o.name||"default",l=new DB(o.connection);if(o.schema)try{let u=await import(o.schema),d=u.default||u.schema;if(Array.isArray(d))for(let n of d)l.defineSchema(n);}catch(u){throw t.error(`Failed to load schema: ${o.schema}`,u),u}for(let u of r)l.defineSchema(u);s.set(c,l),t.success(`Database '${c}' ready`);}if(s.size===0&&r.length>0){let o=new DB(":memory:");for(let c of r)o.defineSchema(c);s.set("default",o),t.success("Database 'default' ready (in-memory for plugins)");}return s}async function P(e,r){if(!e.api)return [];r.info(`Loading routes from ${e.api.directory}...`);let t=[];try{let s=await T(e.api.directory);for(let a of s)try{let o=await import(a),c=o.default||o.routes;Array.isArray(c)&&t.push(...c);}catch(o){r.error(`Failed to load routes from ${a}`,o);}return r.success(`Routes loaded \u2192 ${t.length} routes`),t}catch(s){return r.error("Failed to scan route directory",s),[]}}async function T(e){let r=[];try{let t=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(e));for(let s of t)r.push(`${e}/${s}`);}catch{}return r}function J(e,r){let t=r?.onConfig?r.onConfig(e):e,s=new Logger(t.debug),a=new PluginRegistry(s),o=new ResourceMerger(s),c=new Map,l=new Map,u=null,d=null,n={config:t,databases:c,plugins:[]},b={config:t,server:null,databases:c,plugins:[],middlewares:l,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>n,getMiddleware:i=>l.get(i)};async function C(){if(!t.plugins||t.plugins.length===0){s.info("No plugins to register");return}s.phase("REGISTER");for(let p of t.plugins)await a.register(p,b);n.plugins=a.getAll(),a.collectMiddlewares().forEach((p,f)=>l.set(f,p));}async function v(){s.phase("AWAKE");try{d=await k(t,s),n.clientBuild=d;let i=await F(t,s);n.uiBuild=i;let p=await H(t,s);n.styleBuild=p;let f=a.collectSchemas(),m=await U(t,f,s);c.clear(),m.forEach((h,g)=>c.set(g,h)),await a.callHook("onAwake",n),await r?.onAwake?.(n);}catch(i){throw await r?.onError?.(n,"AWAKE",i),i}}async function $(){s.phase("START");try{let i=await P(t,s),p=a.collectRoutes(),m=[...t.routes||[],...i],h=o.mergeRoutes(m,p),g=t.static?Array.isArray(t.static)?t.static:[t.static]:[],B=a.collectStatic(),A=o.mergeStatic(g,B);s.info("Creating server...");let S;for(let y of n.plugins){let w=y;if(w.__spaErrorHandler){S=w.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${y.name}`);break}}u=await server({port:t.server?.port||3e3,hostname:t.server?.host||"localhost",logging:t.server?.logging,routes:h,static:A.length>0?A:void 0,security:t.security,middlewares:t.middlewares,i18n:t.i18n?{defaultLanguage:t.i18n.defaultLanguage,supportedLanguages:t.i18n.supportedLanguages,basePath:t.i18n.basePath,fileExtension:t.i18n.fileExtension||"json"}:void 0,onError:S}),c.forEach((y,w)=>{u.db.set(w,y);}),n.server=u,b.server=u,s.success(`Server created \u2192 ${t.server?.host||"localhost"}:${t.server?.port||3e3}`),await a.callHook("onStart",n),await r?.onStart?.(n);}catch(i){throw await r?.onError?.(n,"START",i),i}}async function x(){s.phase("READY");try{await u.start(),s.success(`Server running on http://${t.server?.host||"localhost"}:${t.server?.port||3e3}`),await a.callHook("onReady",n),await r?.onReady?.(n);}catch(i){throw await r?.onError?.(n,"READY",i),i}}return {config:t,server:u,databases:c,plugins:n.plugins,middlewares:l,async start(){await C(),await v(),await $(),await x();},async stop(){s.info("Stopping server...");try{u&&await u.stop(),c.forEach((i,p)=>{i.close(),s.info(`Database '${p}' closed`);}),await a.callHook("onShutdown",n),await r?.onFinish?.(n),s.success("Server stopped");}catch(i){throw s.error("Failed to stop server",i),i}},async restart(){await this.stop(),await this.start();},getContext(){return n},getMiddleware(i){return l.get(i)}}}
export{J as createApp};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map