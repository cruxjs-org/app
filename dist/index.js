import {Logger,PluginRegistry,ResourceMerger}from'@cruxjs/base';export*from'@cruxjs/base';import {server}from'@minejs/server';import {DB}from'@minejs/db';import {setupAuto}from'@minejs/i18n';async function k(t,r){if(!t.client)return null;r.info("Building client...");try{let e=await Bun.build({entrypoints:[t.client.entry],outdir:t.client.output,target:t.client.target||"browser",minify:t.client.minify??!t.debug,sourcemap:t.client.sourcemap??t.debug?"inline":"none",external:t.client.external||[]});if(!e.success)throw new Error("Build failed");let s=e.outputs.map(i=>i.path);return r.success(`Client built \u2192 ${s.join(", ")}`),{success:!0,outputs:s}}catch(e){throw r.error("Failed to build client",e),e}}async function F(t,r){if(!t.ui)return null;r.info(`Building UI from package: ${t.ui.package}...`);try{if(await Bun.spawn(["bun","add",t.ui.package],{stdio:["ignore","pipe","pipe"]}).exited!==0)throw new Error(`Failed to install UI package: ${t.ui.package}`);return r.info(`UI package installed: ${t.ui.package}`),r.success(`UI built \u2192 ${t.ui.output}`),{success:!0,output:t.ui.output}}catch(e){throw r.error("Failed to build UI",e),e}}async function H(t,r){if(!t.style)return null;r.info(`Building styles from: ${t.style.entry}...`);try{if(!(await Bun.build({entrypoints:[t.style.entry],outdir:t.style.output,minify:t.style.minify??!t.debug,sourcemap:t.style.sourcemap??t.debug?"inline":"none"})).success)throw new Error("Style build failed");return r.success(`Styles built \u2192 ${t.style.output}`),{success:!0,output:t.style.output}}catch(e){throw r.error("Failed to build styles",e),e}}async function P(t,r,e){let s=new Map;if(!t.database&&r.length===0)return e.info("No database config, skipping setup"),s;let i=t.database?Array.isArray(t.database)?t.database:[t.database]:[];e.info("Setting up databases...");for(let o of i){let c=o.name||"default",l=new DB(o.connection);if(o.schema)try{let u=await import(o.schema),d=u.default||u.schema;if(Array.isArray(d))for(let a of d)l.defineSchema(a);}catch(u){throw e.error(`Failed to load schema: ${o.schema}`,u),u}for(let u of r)l.defineSchema(u);s.set(c,l),e.success(`Database '${c}' ready`);}if(s.size===0&&r.length>0){let o=new DB(":memory:");for(let c of r)o.defineSchema(c);s.set("default",o),e.success("Database 'default' ready (in-memory for plugins)");}return s}async function T(t,r){if(t.i18n){r.info("Setting up i18n...");try{await setupAuto({defaultLanguage:t.i18n.defaultLanguage,supportedLanguages:t.i18n.supportedLanguages,basePath:t.i18n.basePath,fileExtension:t.i18n.fileExtension||"json"}),r.success(`i18n ready \u2192 ${t.i18n.supportedLanguages.join(", ")}`);}catch(e){throw r.error("Failed to setup i18n",e),e}}}async function U(t,r){if(!t.api)return [];r.info(`Loading routes from ${t.api.directory}...`);let e=[];try{let s=await j(t.api.directory);for(let i of s)try{let o=await import(i),c=o.default||o.routes;Array.isArray(c)&&e.push(...c);}catch(o){r.error(`Failed to load routes from ${i}`,o);}return r.success(`Routes loaded \u2192 ${e.length} routes`),e}catch(s){return r.error("Failed to scan route directory",s),[]}}async function j(t){let r=[];try{let e=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(t));for(let s of e)r.push(`${t}/${s}`);}catch{}return r}function Q(t,r){let e=r?.onConfig?r.onConfig(t):t,s=new Logger(e.debug),i=new PluginRegistry(s),o=new ResourceMerger(s),c=new Map,l=new Map,u=null,d=null,a={config:e,databases:c,plugins:[]},b={config:e,server:null,databases:c,plugins:[],middlewares:l,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>a,getMiddleware:n=>l.get(n)};async function S(){if(!e.plugins||e.plugins.length===0){s.info("No plugins to register");return}s.phase("REGISTER");for(let p of e.plugins)await i.register(p,b);a.plugins=i.getAll(),i.collectMiddlewares().forEach((p,y)=>l.set(y,p));}async function C(){s.phase("AWAKE");try{d=await k(e,s),a.clientBuild=d;let n=await F(e,s);a.uiBuild=n;let p=await H(e,s);a.styleBuild=p;let y=i.collectSchemas(),g=await P(e,y,s);c.clear(),g.forEach((h,m)=>c.set(m,h)),await T(e,s),await i.callHook("onAwake",a),await r?.onAwake?.(a);}catch(n){throw await r?.onError?.(a,"AWAKE",n),n}}async function L(){s.phase("START");try{let n=await U(e,s),p=i.collectRoutes(),g=[...e.routes||[],...n],h=o.mergeRoutes(g,p),m=e.static?Array.isArray(e.static)?e.static:[e.static]:[],v=i.collectStatic(),A=o.mergeStatic(m,v);s.info("Creating server...");let E;for(let f of a.plugins){let w=f;if(w.__spaErrorHandler){E=w.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${f.name}`);break}}u=server({port:e.server?.port||3e3,hostname:e.server?.host||"localhost",logging:e.server?.logging,routes:h,static:A.length>0?A:void 0,security:e.security,middlewares:e.middlewares,i18n:e.i18n?{defaultLanguage:e.i18n.defaultLanguage,supportedLanguages:e.i18n.supportedLanguages}:void 0,onError:E}),c.forEach((f,w)=>{u.db.set(w,f);}),a.server=u,b.server=u,s.success(`Server created \u2192 ${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await i.callHook("onStart",a),await r?.onStart?.(a);}catch(n){throw await r?.onError?.(a,"START",n),n}}async function $(){s.phase("READY");try{await u.start(),s.success(`Server running on http://${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await i.callHook("onReady",a),await r?.onReady?.(a);}catch(n){throw await r?.onError?.(a,"READY",n),n}}return {config:e,server:u,databases:c,plugins:a.plugins,middlewares:l,async start(){await S(),await C(),await L(),await $();},async stop(){s.info("Stopping server...");try{u&&await u.stop(),c.forEach((n,p)=>{n.close(),s.info(`Database '${p}' closed`);}),await i.callHook("onShutdown",a),await r?.onFinish?.(a),s.success("Server stopped");}catch(n){throw s.error("Failed to stop server",n),n}},async restart(){await this.stop(),await this.start();},getContext(){return a},getMiddleware(n){return l.get(n)}}}
export{Q as createApp};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map