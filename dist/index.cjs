'use strict';var base=require('@cruxjs/base'),server=require('@minejs/server'),db=require('@minejs/db'),R=require('sass');function _interopNamespace(e){if(e&&e.__esModule)return e;var n=Object.create(null);if(e){Object.keys(e).forEach(function(k){if(k!=='default'){var d=Object.getOwnPropertyDescriptor(e,k);Object.defineProperty(n,k,d.get?d:{enumerable:true,get:function(){return e[k]}});}})}n.default=e;return Object.freeze(n)}var R__namespace=/*#__PURE__*/_interopNamespace(R);async function k(e,r){if(!e.client)return null;r.info("Building client...");try{let t=await Bun.build({entrypoints:[e.client.entry],outdir:e.client.output,target:e.client.target||"browser",minify:e.client.minify??!e.debug,sourcemap:e.client.sourcemap??e.debug?"inline":"none",external:e.client.external||[]});if(!t.success)throw new Error("Build failed");let s=t.outputs.map(a=>a.path);return r.success(`Client built \u2192 ${s.join(", ")}`),{success:!0,outputs:s}}catch(t){throw r.error("Failed to build client",t),t}}async function F(e,r){if(!e.ui)return r.info("No UI config provided, skipping UI build"),null;r.info(`Building UI from package: ${e.ui.package}...`);try{let t=`./node_modules/${e.ui.package}/dist/mineui.css`,s=`${e.ui.output}/min.css`;try{let{mkdir:a}=await import('fs/promises');await a(e.ui.output,{recursive:!0});let i=Bun.file(t);await i.exists()?(await Bun.write(s,i),r.info(`Copied UI CSS \u2192 ${s}`)):r.info(`UI source file not found: ${t}`);}catch(a){r.error(`Failed to copy UI CSS: ${a}`);}return r.success(`UI built \u2192 ${e.ui.output}`),{success:!0,output:e.ui.output}}catch(t){throw r.error("Failed to build UI",t),t}}async function H(e,r){if(!e.style)return r.info("No style config provided, skipping style build"),null;r.info(`Building styles from: ${e.style.entry}...`);try{let t=e.style.output,s=t.lastIndexOf("/"),a=t.substring(0,s),i=t.substring(s+1),{mkdir:c}=await import('fs/promises');await c(a,{recursive:!0});let l=R__namespace.compile(e.style.entry,{style:e.style.minify?"compressed":"expanded",sourceMap:!!e.style.sourcemap});return await Bun.write(t,l.css),r.info(`Compiled SCSS to CSS \u2192 ${i}`),r.success(`Styles built \u2192 ${t}`),{success:!0,output:t}}catch(t){return r.error("Failed to build styles",t),{success:false,output:e.style?.output||"unknown"}}}async function U(e,r,t){let s=new Map;if(!e.database&&r.length===0)return t.info("No database config, skipping setup"),s;let a=e.database?Array.isArray(e.database)?e.database:[e.database]:[];t.info("Setting up databases...");for(let i of a){let c=i.name||"default",l=new db.DB(i.connection);if(i.schema)try{let u=await import(i.schema),d=u.default||u.schema;if(Array.isArray(d))for(let n of d)l.defineSchema(n);}catch(u){throw t.error(`Failed to load schema: ${i.schema}`,u),u}for(let u of r)l.defineSchema(u);s.set(c,l),t.success(`Database '${c}' ready`);}if(s.size===0&&r.length>0){let i=new db.DB(":memory:");for(let c of r)i.defineSchema(c);s.set("default",i),t.success("Database 'default' ready (in-memory for plugins)");}return s}async function T(e,r){if(!e.api)return [];r.info(`Loading routes from ${e.api.directory}...`);let t=[];try{let s=await P(e.api.directory);for(let a of s)try{let i=await import(a),c=i.default||i.routes;Array.isArray(c)&&t.push(...c);}catch(i){r.error(`Failed to load routes from ${a}`,i);}return r.success(`Routes loaded \u2192 ${t.length} routes`),t}catch(s){return r.error("Failed to scan route directory",s),[]}}async function P(e){let r=[];try{let t=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(e));for(let s of t)r.push(`${e}/${s}`);}catch{}return r}function J(e,r){let t=r?.onConfig?r.onConfig(e):e,s=new base.Logger(t.debug),a=new base.PluginRegistry(s),i=new base.ResourceMerger(s),c=new Map,l=new Map,u=null,d=null,n={config:t,databases:c,plugins:[]},b={config:t,server:null,databases:c,plugins:[],middlewares:l,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>n,getMiddleware:o=>l.get(o)};async function C(){if(!t.plugins||t.plugins.length===0){s.info("No plugins to register");return}s.phase("REGISTER");for(let p of t.plugins)await a.register(p,b);n.plugins=a.getAll(),a.collectMiddlewares().forEach((p,f)=>l.set(f,p));}async function v(){s.phase("AWAKE");try{d=await k(t,s),n.clientBuild=d;let o=await F(t,s);n.uiBuild=o;let p=await H(t,s);n.styleBuild=p;let f=a.collectSchemas(),m=await U(t,f,s);c.clear(),m.forEach((h,g)=>c.set(g,h)),await a.callHook("onAwake",n),await r?.onAwake?.(n);}catch(o){throw await r?.onError?.(n,"AWAKE",o),o}}async function $(){s.phase("START");try{let o=await T(t,s),p=a.collectRoutes(),m=[...t.routes||[],...o],h=i.mergeRoutes(m,p),g=t.static?Array.isArray(t.static)?t.static:[t.static]:[],x=a.collectStatic(),A=i.mergeStatic(g,x);s.info("Creating server...");let S;for(let y of n.plugins){let w=y;if(w.__spaErrorHandler){S=w.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${y.name}`);break}}u=await server.server({port:t.server?.port||3e3,hostname:t.server?.host||"localhost",logging:t.server?.logging,routes:h,static:A.length>0?A:void 0,security:t.security,middlewares:t.middlewares,i18n:t.i18n?{defaultLanguage:t.i18n.defaultLanguage,supportedLanguages:t.i18n.supportedLanguages}:void 0,onError:S}),c.forEach((y,w)=>{u.db.set(w,y);}),n.server=u,b.server=u,s.success(`Server created \u2192 ${t.server?.host||"localhost"}:${t.server?.port||3e3}`),await a.callHook("onStart",n),await r?.onStart?.(n);}catch(o){throw await r?.onError?.(n,"START",o),o}}async function B(){s.phase("READY");try{await u.start(),s.success(`Server running on http://${t.server?.host||"localhost"}:${t.server?.port||3e3}`),await a.callHook("onReady",n),await r?.onReady?.(n);}catch(o){throw await r?.onError?.(n,"READY",o),o}}return {config:t,server:u,databases:c,plugins:n.plugins,middlewares:l,async start(){await C(),await v(),await $(),await B();},async stop(){s.info("Stopping server...");try{u&&await u.stop(),c.forEach((o,p)=>{o.close(),s.info(`Database '${p}' closed`);}),await a.callHook("onShutdown",n),await r?.onFinish?.(n),s.success("Server stopped");}catch(o){throw s.error("Failed to stop server",o),o}},async restart(){await this.stop(),await this.start();},getContext(){return n},getMiddleware(o){return l.get(o)}}}
exports.createApp=J;Object.keys(base).forEach(function(k){if(k!=='default'&&!Object.prototype.hasOwnProperty.call(exports,k))Object.defineProperty(exports,k,{enumerable:true,get:function(){return base[k]}})});//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map