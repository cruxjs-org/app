'use strict';var base=require('@cruxjs/base'),logger=require('@minejs/logger'),server=require('@minejs/server'),db=require('@minejs/db'),k=require('sass'),v=require('path');function _interopNamespace(e){if(e&&e.__esModule)return e;var n=Object.create(null);if(e){Object.keys(e).forEach(function(k){if(k!=='default'){var d=Object.getOwnPropertyDescriptor(e,k);Object.defineProperty(n,k,d.get?d:{enumerable:true,get:function(){return e[k]}});}})}n.default=e;return Object.freeze(n)}var k__namespace=/*#__PURE__*/_interopNamespace(k);var v__namespace=/*#__PURE__*/_interopNamespace(v);async function j(s,r){if(!s.client)return null;r.info("Building client...");try{let e=await Bun.build({entrypoints:[s.client.entry],outdir:s.client.output,target:s.client.target||"browser",minify:s.client.minify??!s.debug,sourcemap:s.client.sourcemap??s.debug?"inline":"none",external:s.client.external||[]});if(!e.success)throw new Error("Build failed");let t=e.outputs.map(i=>i.path);return await H(t,s,r),r.debug(`Client built \u2192 ${t.join(", ")}`),{success:!0,outputs:t}}catch(e){throw r.error("Failed to build client",e.message),e}}async function H(s,r,e){if(!r.client?.entry)return;let t=s.find(i=>i.endsWith(".js"));if(t){e.info("Optimizing bundle (removing unused icons)...");try{let n=await Bun.file(t).text(),u=[],p=new Set,o=0;for(;o<n.length;){let f=n[o];if(f==='"'||f==="'"){let m=f;for(o++;o<n.length&&!(n[o]===m&&n[o-1]!=="\\");)o++;}else if(f==="{"){let m=n.substring(o+1,o+100);if(/^\s*(?:["'][\w-]+["']|\w+)\s*:\s*\{\s*(?:category|viewBox|svg)\b/.test(m)){let a=o,l=1,d=o+1,b=!1,x="";for(;d<n.length;){let g=n[d];if(b)g===x&&n[d-1]!=="\\"&&(b=!1);else if(g==='"'||g==="'")b=!0,x=g;else if(g==="{")l++;else if(g==="}"&&(l--,l===0))break;d++;}let C=d+1,$=n.substring(a,C),E=[],R=/(?:["']([\w-]+)["']|(\w+))\s*:\s*\{/g,A;for(;(A=R.exec($))!==null;){let g=A[1]||A[2];E.push(g),p.add(g);}u.push({start:a,end:C,keys:E}),o=C-1;}}o++;}if(e.debug(`Found ${u.length} icon maps with ${p.size} total icons.`),p.size===0)return;let w=v__namespace.dirname(r.client.entry),c=new Bun.Glob("**/*.{ts,tsx,js,jsx}"),y=new Set;y.add("angle-down"),y.add("info"),y.add("circle-info"),y.add("circle-check"),y.add("circle-xmark"),y.add("triangle-exclamation");for await(let f of c.scan({cwd:w})){let m=v__namespace.join(w,f),a=await Bun.file(m).text();for(let l of p)if(!y.has(l)){let d=l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");new RegExp(`\\b${d}\\b`).test(a)&&y.add(l);}}e.debug(`Used icons: ${y.size}`);let h="",S=0;for(let f of u){h+=n.substring(S,f.start);let m=n.substring(f.start,f.end),a;try{a=new Function("return "+m)();}catch{e.warn("Failed to parse map, keeping as is"),h+=m,S=f.end;continue}let l=0;for(let d of f.keys)y.has(d)||(delete a[d],l++);l>0?h+=JSON.stringify(a):h+=m,S=f.end;}h+=n.substring(S),await Bun.write(t,h),e.info("Bundle optimized");}catch(i){e.warn("Failed to optimize bundle",i.message);}}}async function I(s,r){if(!s.style)return r.info("No style config provided, skipping style build"),null;r.info(`Building styles from: ${s.style.entry}...`);try{let e=s.style.output,t=e.lastIndexOf("/"),i=e.substring(0,t),n=e.substring(t+1),{mkdir:u}=await import('fs/promises');await u(i,{recursive:!0});let p=k__namespace.compile(s.style.entry,{style:s.style.minify?"compressed":"expanded",sourceMap:!!s.style.sourcemap});return await Bun.write(e,p.css),r.info(`Compiled SCSS to CSS \u2192 ${n}`),r.debug(`Styles built \u2192 ${e}`),{success:!0,output:e}}catch(e){return r.error("Failed to build styles",e.message),{success:false,output:s.style?.output||"unknown"}}}async function z(s,r,e){let t=new Map;if(!s.database&&r.length===0)return e.info("No database config, skipping setup"),t;let i=s.database?Array.isArray(s.database)?s.database:[s.database]:[];e.info("Setting up databases...");for(let n of i){let u=n.name||"default",p=new db.DB(n.connection);if(n.schema)try{let o=await import(n.schema),w=o.default||o.schema;if(Array.isArray(w))for(let c of w)p.defineSchema(c);}catch(o){throw e.error(`Failed to load schema: ${n.schema}`,o.message),o}for(let o of r)p.defineSchema(o);t.set(u,p),e.debug(`Database '${u}' ready`);}if(t.size===0&&r.length>0){let n=new db.DB(":memory:");for(let u of r)n.defineSchema(u);t.set("default",n),e.debug("Database 'default' ready (in-memory for plugins)");}return t}async function P(s,r){if(!s.api)return [];r.info(`Loading routes from ${s.api.directory}...`);let e=[];try{let t=await T(s.api.directory);for(let i of t)try{let n=await import(i),u=n.default||n.routes;Array.isArray(u)&&e.push(...u);}catch(n){r.error(`Failed to load routes from ${i}`,n.message);}return r.debug(`Routes loaded \u2192 ${e.length} routes`),e}catch(t){return r.error("Failed to scan route directory",t.message),[]}}async function T(s){let r=[];try{let e=await Array.fromAsync(new Bun.Glob("**/*.{ts,js}").scan(s));for(let t of e)r.push(`${s}/${t}`);}catch{}return r}function Q(s,r){let e=r?.onConfig?r.onConfig(s):s,t=new logger.Logger(e.debug?"debug":"info",true,"CruxJS"),i=new base.PluginRegistry(t),n=new base.ResourceMerger(t),u=new Map,p=new Map,o=null,w=null,c={config:e,databases:u,plugins:[]},y={config:e,server:null,databases:u,plugins:[],middlewares:p,start:async()=>{},stop:async()=>{},restart:async()=>{},getContext:()=>c,getMiddleware:a=>p.get(a)};async function h(){if(!e.plugins||e.plugins.length===0){t.info("No plugins to register");return}t.debug("REGISTER");for(let l of e.plugins)await i.register(l,y);c.plugins=i.getAll(),i.collectMiddlewares().forEach((l,d)=>p.set(d,l));}async function S(){t.debug("AWAKE");try{w=await j(e,t),c.clientBuild=w;let a=await I(e,t);c.styleBuild=a;let l=i.collectSchemas(),d=await z(e,l,t);u.clear(),d.forEach((b,x)=>u.set(x,b)),await i.callHook("onAwake",c),await r?.onAwake?.(c);}catch(a){throw await r?.onError?.(c,"AWAKE",a),a}}async function f(){t.debug("START");try{let a=await P(e,t),l=i.collectRoutes(),b=[...e.routes||[],...a],x=n.mergeRoutes(b,l),C=e.static?Array.isArray(e.static)?e.static:[e.static]:[],$=i.collectStatic(),E=n.mergeStatic(C,$);t.info("Creating server...");let R;for(let A of c.plugins){let g=A;if(g.__spaErrorHandler){R=g.__spaErrorHandler,console.log(`[CruxJS] \u2713 Error handler collected from: ${A.name}`);break}}o=await server.server({port:e.server?.port||3e3,hostname:e.server?.host||"localhost",logging:e.server?.logging,routes:x,static:E.length>0?E:void 0,security:e.security,middlewares:e.middlewares,i18n:e.i18n?{defaultLanguage:e.i18n.defaultLanguage,supportedLanguages:e.i18n.supportedLanguages,basePath:e.i18n.basePath,fileExtension:e.i18n.fileExtension||"json"}:void 0,onError:R}),u.forEach((A,g)=>{o.db.set(g,A);}),c.server=o,y.server=o,t.debug(`Server created \u2192 ${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await i.callHook("onStart",c),await r?.onStart?.(c);}catch(a){throw await r?.onError?.(c,"START",a),a}}async function m(){t.debug("READY");try{await o.start(),t.debug(`Server running on http://${e.server?.host||"localhost"}:${e.server?.port||3e3}`),await i.callHook("onReady",c),await r?.onReady?.(c);}catch(a){throw await r?.onError?.(c,"READY",a),a}}return {config:e,server:o,databases:u,plugins:c.plugins,middlewares:p,async start(){await h(),await S(),await f(),await m();},async stop(){t.info("Stopping server...");try{o&&await o.stop(),u.forEach((a,l)=>{a.close(),t.info(`Database '${l}' closed`);}),await i.callHook("onShutdown",c),await r?.onFinish?.(c),t.debug("Server stopped");}catch(a){throw t.error("Failed to stop server",a.message),a}},async restart(){await this.stop(),await this.start();},getContext(){return c},getMiddleware(a){return p.get(a)}}}
exports.createApp=Q;exports.optimizeBundle=H;Object.keys(base).forEach(function(k){if(k!=='default'&&!Object.prototype.hasOwnProperty.call(exports,k))Object.defineProperty(exports,k,{enumerable:true,get:function(){return base[k]}})});//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map